<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8"> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>人が残るカメラ</title>
    <style>
        body { background: #000; color: #fff; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; margin: 0; }
        #canvas-container { position: relative; width: 100%; max-width: 640px; margin-bottom: 20px; }
        canvas { width: 100%; border: 2px solid #333; border-radius: 8px; background: #111; }
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; background: #222; padding: 20px; border-radius: 10px; width: 100%; max-width: 600px; }
        .control-group { display: flex; flex-direction: column; gap: 5px; }
        label { font-size: 12px; color: #aaa; }
        input { width:40%;padding: 8px; border-radius: 4px; border: none; background: #333; color: #fff; }
        button { grid-column: span 2; padding: 12px; font-weight: bold; cursor: pointer; border: none; border-radius: 4px; background: #007bff; color: #fff; }
        button:disabled { background: #444; cursor: not-allowed; }
        #status { grid-column: span 2; text-align: center; color: #ffeb3b; font-size: 14px; min-height: 1.2em; }
    </style>
</head>
<body>

<div id="canvas-container">
    <canvas id="mainCanvas"></canvas>
    <video id="video" style="display:none" autoplay playsinline></video>
</div>

<div class="controls">
    <div class="control-group">
        <label>撮影枚数</label>
        <input type="number" id="maxFrames" value="5" min="1">
    </div>
    <div class="control-group">
        <label>撮影間隔 (秒)</label>
        <input type="number" id="interval" value="2" min="0.5" step="0.5">
    </div>
    <div class="control-group">
        <label>開始遅延 (秒)</label>
        <input type="number" id="delay" value="3" min="0">
    </div>
    <div class="control-group">
        <label>感度 (低いほど敏感)</label>
        <input type="number" id="threshold" value="30" min="1">
    </div>
    <div id="status">準備中...</div>
    <button id="startBtn">背景学習 & 撮影開始</button>
</div>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('mainCanvas');
const ctx = canvas.getContext('2d', { willReadFrequently: true });
const status = document.getElementById('status');
const startBtn = document.getElementById('startBtn');

let bgData = null; // 背景データ
let frameCount = 0;

// カメラ初期化
async function init() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        video.srcObject = stream;
        video.onloadedmetadata = () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            status.innerText = "待機中";
        };
    } catch (e) { status.innerText = "カメラエラー: " + e.message; }
}

function getFrameData() {
    const tempCanvas = document.createElement('canvas');
    tempCanvas.width = canvas.width;
    tempCanvas.height = canvas.height;
    const tempCtx = tempCanvas.getContext('2d');
    tempCtx.drawImage(video, 0, 0);
    return tempCtx.getImageData(0, 0, canvas.width, canvas.height);
}

async function startCapture() {
    const max = parseInt(document.getElementById('maxFrames').value);
    const interval = parseFloat(document.getElementById('interval').value) * 1000;
    const delay = parseFloat(document.getElementById('delay').value) * 1000;
    const thresh = parseInt(document.getElementById('threshold').value);

    startBtn.disabled = true;
    frameCount = 0;

    // 1. 背景学習
    status.innerText = "背景を学習中...（動かないでください）";
    await new Promise(r => setTimeout(r, 1000));
    bgData = getFrameData();
    
    // 初回背景を描画
    ctx.putImageData(bgData, 0, 0);

    // 2. カウントダウン
    for(let i = delay/1000; i > 0; i--) {
        status.innerText = `開始まで ${i}秒...`;
        await new Promise(r => setTimeout(r, 1000));
    }

    // 3. 撮影ループ
    const timer = setInterval(() => {
        status.innerText = `撮影中: ${frameCount + 1} / ${max}`;
        
        const currentData = getFrameData();
        const output = ctx.getImageData(0, 0, canvas.width, canvas.height);
        
        // 背景と比較して差分があるピクセルだけを上書き
        for (let i = 0; i < currentData.data.length; i += 4) {
            const rDiff = Math.abs(currentData.data[i] - bgData.data[i]);
            const gDiff = Math.abs(currentData.data[i+1] - bgData.data[i+1]);
            const bDiff = Math.abs(currentData.data[i+2] - bgData.data[i+2]);

            if (rDiff + gDiff + bDiff > thresh) {
                output.data[i] = currentData.data[i];
                output.data[i+1] = currentData.data[i+1];
                output.data[i+2] = currentData.data[i+2];
                output.data[i+3] = 255;
            }
        }
        
        ctx.putImageData(output, 0, 0);
        frameCount++;

        if (frameCount >= max) {
            clearInterval(timer);
            status.innerText = "撮影完了！";
            startBtn.disabled = false;
        }
    }, interval);
}

startBtn.onclick = startCapture;
init();
</script>
</body>
</html>
