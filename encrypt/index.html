<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Advanced Encryption Suite</title>

<style>
:root{
    --bg:#ffffff;
    --text:#000000;
    --accent:#ffcc00;
}
body.dark{
    --bg:#000000;
    --text:#ffffff;
}
body{
    background:var(--bg);
    color:var(--text);
    font-family:system-ui;
    max-width:950px;
    margin:40px auto;
}
.section{
    border:2px solid var(--text);
    padding:20px;
    margin-top:25px;
}
input,textarea,select{
    width:100%;
    padding:10px;
    border:2px solid var(--text);
    background:var(--bg);
    color:var(--text);
}
button{
    padding:10px 18px;
    border:2px solid var(--text);
    background:var(--accent);
    color:#000;
    cursor:pointer;
    margin-top:10px;
}
button:hover{
    background:var(--text);
    color:var(--accent);
}
.progress{
    height:8px;
    border:2px solid var(--text);
    margin-top:15px;
}
.bar{
    height:100%;
    width:0%;
    background:var(--accent);
}
.toggle{
    float:right;
}
</style>
</head>
<body>

<h2>Encryption Suite</h2>
<button class="toggle" onclick="toggleMode()">Light/Dark</button>

<div class="section">
<label>パスワード</label>
<input type="password" id="password">
</div>

<div class="section">
<h3>ファイル処理（Argon2 + AES-GCM）</h3>
<input type="file" id="fileInput">
<button onclick="encryptFile()">暗号化</button>
<button onclick="decryptFile()">復号</button>
<div class="progress"><div class="bar" id="bar"></div></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/argon2-browser/dist/argon2-bundled.min.js"></script>
<script>

const MAGIC=new TextEncoder().encode("KENC");
const VERSION=1;
const ALG_ID=1; // 1=AES-GCM
const CHUNK_SIZE=1024*1024*4; // 4MB

function toggleMode(){
    document.body.classList.toggle("dark");
}

async function deriveKey(password,salt){
    const hash=await argon2.hash({
        pass:password,
        salt:salt,
        time:3,
        mem:65536,
        hashLen:32,
        parallelism:1,
        type:argon2.ArgonType.Argon2id
    });
    return crypto.subtle.importKey(
        "raw",
        hash.hash,
        {name:"AES-GCM"},
        false,
        ["encrypt","decrypt"]
    );
}

function concat(...arrs){
    let total=arrs.reduce((s,a)=>s+a.length,0);
    let out=new Uint8Array(total);
    let offset=0;
    arrs.forEach(a=>{
        out.set(a,offset);
        offset+=a.length;
    });
    return out;
}

async function encryptFile(){
    const file=fileInput.files[0];
    if(!file)return alert("ファイル未選択");
    const pw=password.value;
    if(!pw)return alert("パスワード未入力");

    bar.style.width="5%";

    const salt=crypto.getRandomValues(new Uint8Array(16));
    const key=await deriveKey(pw,salt);

    const header=concat(
        MAGIC,
        new Uint8Array([VERSION]),
        new Uint8Array([ALG_ID]),
        salt,
        new Uint8Array(new Uint32Array([CHUNK_SIZE]).buffer)
    );

    let chunks=[header];

    const reader=file.stream().getReader();
    let total=0;
    while(true){
        const {done,value}=await reader.read();
        if(done)break;

        const iv=crypto.getRandomValues(new Uint8Array(12));
        const enc=await crypto.subtle.encrypt(
            {name:"AES-GCM",iv:iv},
            key,
            value
        );
        chunks.push(iv);
        chunks.push(new Uint8Array(enc));

        total+=value.length;
        bar.style.width=Math.min(90,(total/file.size)*100)+"%";
    }

    const finalBlob=new Blob(chunks);
    download(finalBlob,file.name+".encrypted");
    bar.style.width="100%";
}

async function decryptFile(){
    const file=fileInput.files[0];
    if(!file)return alert("ファイル未選択");
    const pw=password.value;
    if(!pw)return alert("パスワード未入力");

    const buffer=new Uint8Array(await file.arrayBuffer());

    if(new TextDecoder().decode(buffer.slice(0,4))!=="KENC"){
        return alert("非対応フォーマット");
    }

    const salt=buffer.slice(6,22);
    const key=await deriveKey(pw,salt);

    let offset=26;
    let output=[];

    while(offset<buffer.length){
        const iv=buffer.slice(offset,offset+12);
        offset+=12;
        const chunkEnd=Math.min(offset+CHUNK_SIZE+16,buffer.length);
        const data=buffer.slice(offset,chunkEnd);
        offset=chunkEnd;

        try{
            const dec=await crypto.subtle.decrypt(
                {name:"AES-GCM",iv:iv},
                key,
                data
            );
            output.push(new Uint8Array(dec));
        }catch{
            return alert("復号失敗");
        }
    }

    const blob=new Blob(output);
    download(blob,file.name.replace(".encrypted",""));
}

function download(blob,name){
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download=name;
    a.click();
}

</script>
</body>
</html>
